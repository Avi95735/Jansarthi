<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Complaint Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {margin: 0; padding: 0; box-sizing: border-box;}
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #2e7d32, #66bb6a);
      display: flex; justify-content: center; align-items: center;
      min-height: 100vh; padding: 20px;
    }
    .container {
      width: 100%; max-width: 750px; background: #fff;
      padding: 30px; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      animation: fadeIn 0.8s ease-in-out;
    }
    @keyframes fadeIn { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
    h1 {text-align: center; color: #333; margin-bottom: 20px;}
    .form-group {position: relative; margin-bottom: 20px;}
    select,input[type="text"],textarea {
      width: 100%; padding: 12px;
      border: 2px solid #ddd; border-radius: 10px; font-size: 14px;
      transition: border 0.3s, box-shadow 0.3s;
    }
    input:focus,textarea:focus,select:focus{border-color:#2e7d32;box-shadow:0 0 6px rgba(46,125,50,0.3);outline:none;}
    textarea{resize:none;height:100px;}
    .mic-icon{position:absolute;right:10px;top:37px;font-size:20px;color:#2e7d32;cursor:pointer;}
    .upload-btn,.submit-btn{
      width: 100%; padding: 14px; border:none; border-radius:12px;
      color:#fff; font-size:16px; font-weight:600; cursor:pointer; transition:0.3s;
    }
    .upload-btn{background:#388e3c;margin-bottom:10px;}
    .upload-btn:hover{background:#1b5e20;}
    .submit-btn{background:#2e7d32;}
    .submit-btn:hover{background:#1b5e20;transform:scale(1.02);}
    .preview img,.preview video{width:80px;height:80px;border-radius:10px;object-fit:cover;border:2px solid #ddd;}
    .message {margin-bottom:15px; font-weight:600; text-align:center;}
    .message.success {color:green;}
    .message.error {color:red;}
  </style>
</head>
<body>
<div class="container">
  <h1>üìù Submit a Complaint</h1>
  <div id="msg" class="message"></div>
  <form id="pftForm" method="POST" action="/submitComplaint" enctype="multipart/form-data">
    <div class="form-group">
      <label for="category">Complaint Category:</label>
      <select id="category" name="category" required>
        <option value="" disabled <%= !category || category === 'Parks & Trees' ? 'selected' : '' %>>Select a category</option>
        <option value="Earthquake" <%= category === 'Earthquake' ? 'selected' : '' %>>Earthquake</option>
        <option value="Floods" <%= category === 'Floods' ? 'selected' : '' %>>Floods</option>
        <option value="Cyclone" <%= category === 'Cyclone' ? 'selected' : '' %>>Cyclone</option>
        <option value="Droughts" <%= category === 'Droughts' ? 'selected' : '' %>>Droughts</option>
        <option value="Landslides" <%= category === 'Landslides' ? 'selected' : '' %>>Landslides</option>
        <option value="Tsunami" <%= category === 'Tsunami' ? 'selected' : '' %>>Tsunami</option>
        <option value="Snow Storms" <%= category === 'Snow Storms' ? 'selected' : '' %>>Snow Storms</option>
      </select>
    </div>

    <div class="form-group">
      <label for="subject">Complaint Subject:</label>
      <input type="text" id="subject" name="subject" required>
      <span class="mic-icon" onclick="startVoiceInput('subject')">üé§</span>
    </div>

    <div class="form-group">
      <label for="description">Complaint Description:</label>
      <textarea id="description" name="description" required></textarea>
      <span class="mic-icon" onclick="startVoiceInput('description')">üé§</span>
    </div>

    <div class="form-group">
      <label for="mobile">Mobile Number:</label>
      <div style="display: flex; gap: 10px;">
        <input type="tel" id="mobile" name="mobile" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required style="flex-grow: 1;">
        <button type="button" id="getOtpBtn" onclick="getOtp()" style="padding: 12px 20px; border: none; border-radius: 10px; background: #ff9800; color: #fff; cursor: pointer;">Get OTP</button>
      </div>
    </div>

    <div class="form-group" id="otpGroup" style="display: none;">
      <label for="otp">Enter OTP:</label>
      <div style="display: flex; gap: 10px;">
        <input type="text" id="otp" name="otp" placeholder="Enter 6-digit OTP" required style="flex-grow: 1;">
        <button type="button" id="verifyOtpBtn" onclick="verifyOtp()" style="padding: 12px 20px; border: none; border-radius: 10px; background: #4caf50; color: #fff; cursor: pointer;">Verify OTP</button>
      </div>
    </div>

    <div class="form-group">
      <label for="location">Your Location (Latitude, Longitude):</label>
      <input type="text" id="location" name="location" placeholder="Fetching location..." readonly required>
      <div id="gpsInfo">üìç Fetching location...</div>
    </div>

    <div class="form-group">
      <label>Upload Photo or Video:</label>
      <input type="file" id="media" name="media" accept="image/*,video/*" style="display:none;">
      <button type="button" class="upload-btn" onclick="document.getElementById('media').click()">üì∑üé• Capture & Upload</button>
      <div class="preview" id="preview"></div>
    </div>

    <button type="submit" class="submit-btn" disabled>Submit Complaint</button>
  </form>
</div>

<script>
  let generatedOtp = null;
  function setLocation() {
    const locInput = document.getElementById('location');
    const gpsInfo = document.getElementById('gpsInfo');
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude.toFixed(5);
          const lng = pos.coords.longitude.toFixed(5);
          locInput.value = `${lat},${lng}`;
          gpsInfo.innerText = `üìç Latitude ${lat}, Longitude ${lng}`;
        },
        (err) => {
          locInput.value = '';
          gpsInfo.innerText = '‚ö† ' + err.message;
        }
      );
    } else {
      gpsInfo.innerText = '‚ùå Geolocation is not supported by this browser.';
    }
  }
  setLocation();

  function startVoiceInput(fieldId){
    if(!('webkitSpeechRecognition'in window)){alert("Not supported");return;}
    const rec=new webkitSpeechRecognition();
    rec.lang="en-IN";rec.interimResults=false;rec.maxAlternatives=1;
    rec.start();
    rec.onresult=e=>{
      document.getElementById(fieldId).value=e.results[0][0].transcript;
    };
  }

  document.getElementById("media").addEventListener("change",e=>{
    const preview=document.getElementById("preview"); preview.innerHTML="";
    const file=e.target.files[0]; if(!file)return;
    if(file.type.startsWith("image/")){const img=document.createElement("img");img.src=URL.createObjectURL(file);preview.appendChild(img);}
    else if(file.type.startsWith("video/")){const v=document.createElement("video");v.src=URL.createObjectURL(file);v.controls=true;preview.appendChild(v);}
  });

  async function getOtp() {
    generatedOtp = null;
    const mobileInput = document.getElementById('mobile');
    const getOtpBtn = document.getElementById('getOtpBtn');
    const msgDiv = document.getElementById('msg');

    if (!mobileInput.checkValidity()) {
        msgDiv.innerText = 'Please enter a valid 10-digit mobile number.';
        msgDiv.className = 'message error';
        return;
    }

    getOtpBtn.disabled = true;
    getOtpBtn.innerText = 'Sending...';

    try {
        const response = await fetch('/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mobile: mobileInput.value })
        });
        const result = await response.json();
        if (result.success) {
            generatedOtp = result.otp;
            msgDiv.innerText = `OTP sent to ${mobileInput.value}. For demo, your OTP is: ${result.otp}`;
            msgDiv.className = 'message success';
            document.getElementById('otpGroup').style.display = 'block';
            getOtpBtn.innerText = 'Resend OTP';
        } else {
            msgDiv.innerText = result.message || 'Failed to send OTP.';
            msgDiv.className = 'message error';
        }
    } catch (err) {
        msgDiv.innerText = 'An error occurred while sending OTP.';
        msgDiv.className = 'message error';
    } finally {
        getOtpBtn.disabled = false;
    }
  }

  function verifyOtp() {
    const otpInput = document.getElementById('otp').value;
    const msgDiv = document.getElementById('msg');
    const submitBtn = document.querySelector('.submit-btn');

    if (!otpInput || !generatedOtp) {
        msgDiv.innerText = 'Please get an OTP first.';
        msgDiv.className = 'message error';
        return;
    }

    if (otpInput === generatedOtp) {
        msgDiv.innerText = '‚úÖ OTP Verified Successfully!';
        msgDiv.className = 'message success';
        document.getElementById('verifyOtpBtn').disabled = true;
        document.getElementById('verifyOtpBtn').innerText = 'Verified';
        document.getElementById('otp').readOnly = true;
        submitBtn.disabled = false;
    } else {
        msgDiv.innerText = '‚ùå Invalid OTP. Please try again.';
        msgDiv.className = 'message error';
    }
  }

  document.getElementById("pftForm").addEventListener("submit", async e=>{
    e.preventDefault();
    const form=new FormData(e.target);
    const msgDiv=document.getElementById("msg");
    msgDiv.innerText="‚è≥ Submitting...";
    msgDiv.className="message";

    try {
      const res=await fetch(e.target.action,{method:"POST",body:form});
      
      if (!res.ok) {
        msgDiv.innerText="‚ùå Failed to submit complaint! Server responded with an error.";
        msgDiv.className="message error";
        return;
      }

      const result = await res.json();

      if(result.success){
        msgDiv.innerText=`‚úÖ Complaint submitted successfully! Your Case ID is: ${result.caseId}`;
        msgDiv.className="message success";
        setTimeout(()=>{
         window.location.href=`/complaint-submitted?caseId=${result.caseId}&subject=${encodeURIComponent(result.subject)}&category=${encodeURIComponent(result.category)}&location=${encodeURIComponent(result.location)}`;
        },1000);
      }else{
        msgDiv.innerText=`‚ùå Failed to submit complaint! ${result.message || ''}`;
        msgDiv.className="message error";
      }
    } catch(err){
      console.error(err);
      msgDiv.innerText="‚ö† An error occurred during submission.";
      msgDiv.className="message error";
    }
  });
</script>
</body>
</html>
